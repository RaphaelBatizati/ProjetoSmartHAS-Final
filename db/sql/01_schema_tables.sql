-- db/sql/01_schema_tables.sql
BEGIN EXECUTE IMMEDIATE 'DROP TABLE alert CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE sensor_reading CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE sensors CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE meal_log CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE food_item CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE user_goal CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE users CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN NULL; ELSE RAISE; END IF; END;
/
CREATE TABLE users (
  user_id        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  full_name      VARCHAR2(120) NOT NULL,
  email          VARCHAR2(160) UNIQUE NOT NULL,
  birth_date     DATE,
  height_cm      NUMBER(5,2),
  created_at     TIMESTAMP(6) DEFAULT SYSTIMESTAMP
);
CREATE TABLE sensors (
  sensor_id      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id        NUMBER NOT NULL,
  sensor_type    VARCHAR2(50) NOT NULL,
  name           VARCHAR2(80),
  critical_min   NUMBER,
  critical_max   NUMBER,
  unit           VARCHAR2(20),
  created_at     TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  CONSTRAINT fk_sensors_user FOREIGN KEY (user_id) REFERENCES users(user_id)
);
CREATE TABLE sensor_reading (
  reading_id     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  sensor_id      NUMBER NOT NULL,
  value_num      NUMBER NOT NULL,
  unit           VARCHAR2(20),
  reading_ts     TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  CONSTRAINT fk_reading_sensor FOREIGN KEY (sensor_id) REFERENCES sensors(sensor_id)
);
CREATE TABLE food_item (
  food_id        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name           VARCHAR2(120) NOT NULL,
  kcal_per_100g  NUMBER(8,2)   NOT NULL,
  protein_g_100g NUMBER(8,2)   NOT NULL,
  carbs_g_100g   NUMBER(8,2)   NOT NULL,
  fat_g_100g     NUMBER(8,2)   NOT NULL
);
CREATE TABLE meal_log (
  meal_id        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id        NUMBER NOT NULL,
  food_id        NUMBER NOT NULL,
  grams          NUMBER(8,2)   NOT NULL,
  eaten_at       TIMESTAMP(6)  DEFAULT SYSTIMESTAMP,
  note           VARCHAR2(200),
  CONSTRAINT fk_ml_user FOREIGN KEY (user_id) REFERENCES users(user_id),
  CONSTRAINT fk_ml_food FOREIGN KEY (food_id) REFERENCES food_item(food_id)
);
CREATE TABLE user_goal (
  goal_id        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id        NUMBER NOT NULL,
  goal_type      VARCHAR2(50) NOT NULL,
  target_value   NUMBER       NOT NULL,
  unit           VARCHAR2(20),
  valid_from     DATE         DEFAULT TRUNC(SYSDATE),
  valid_to       DATE,
  CONSTRAINT fk_goal_user FOREIGN KEY (user_id) REFERENCES users(user_id)
);
CREATE TABLE alert (
  alert_id       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  sensor_id      NUMBER NOT NULL,
  reading_id     NUMBER,
  alert_type     VARCHAR2(40) NOT NULL,
  message        VARCHAR2(400),
  created_at     TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
  severity       VARCHAR2(10) DEFAULT 'HIGH',
  CONSTRAINT fk_alert_sensor FOREIGN KEY (sensor_id) REFERENCES sensors(sensor_id),
  CONSTRAINT fk_alert_reading FOREIGN KEY (reading_id) REFERENCES sensor_reading(reading_id)
);
